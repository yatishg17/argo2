name: Build and Deploy to Kubernetes

on:
  push:
    branches:
      - dev

jobs:
  build-and-push:
    permissions:
      contents: write
      packages: write
    runs-on: ubuntu-latest
    steps:
      - name: Checkout source
        uses: actions/checkout@v4

      - name: Log in to container registry
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Build and push image
        run: |
          IMAGE=ghcr.io/${{ github.repository }}/nginx:${{ github.sha }}
          docker build -t "$IMAGE" .
          docker push "$IMAGE"
          echo "IMAGE=$IMAGE" >> "$GITHUB_ENV"

  update-manifests:
    permissions:
      contents: write
      packages: write
    needs: build-and-push
    runs-on: ubuntu-latest
    steps:
      - name: Checkout manifests
        uses: actions/checkout@v4
        with:
          ref: dev

      - name: Debug current image line
        run: |
          echo "Before update:"
          grep -nE '^\s*image:' apps/nginx/base/deployment.yml || echo "No image line found"

      - name: Install yq
        run: |
          sudo wget -qO /usr/local/bin/yq https://github.com/mikefarah/yq/releases/download/v4.44.1/yq_linux_amd64
          sudo chmod +x /usr/local/bin/yq
          yq --version

      - name: Update image in base deployment with yq
        env:
          IMAGE: ${{ env.IMAGE }}
        run: |
          # Set containers[0].image explicitly; adjust index if you have multiple containers
          yq -i '
            (.spec.template.spec.containers[0].image) = env(IMAGE)
          ' apps/nginx/base/deployment.yml

          echo "After update:"
          grep -nE '^\s*image:' apps/nginx/base/deployment.yml || echo "No image line found"

      - name: Commit and push if changed
        run: |
          git config user.name "github-actions"
          git config user.email "actions@github.com"
          git add apps/nginx/base/deployment.yml
          if ! git diff --cached --quiet; then
            git commit -m "Update image to $IMAGE"
            git push origin dev
          else
            echo "No changes detected; skipping commit."
          fi